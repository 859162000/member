<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wanda.member.countermgt.data.TCounterComputeMapper">
  <resultMap id="BaseResultMap" type="com.wanda.member.countermgt.data.TCinemaTicket">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 05 18:37:36 CST 2013.
    -->
    <id column="MEMBER_ID" jdbcType="DECIMAL" property="memberId" />
    <result column="cinema_key" jdbcType="VARCHAR" property="cinemaKey" />
    <result column="ticket_num" jdbcType="INTEGER" property="ticketNum" />
  </resultMap>
  
  <select id="getTicketsCatalogByCinema" parameterType="java.math.BigDecimal" resultMap="BaseResultMap">
  
 select t.member_key member_id,
    d.inner_code cinema_key,
    count(distinct t.bk_ticket_number || '' || t.cinema_key) -
    count(distinct t.re_ticket_number || '' || t.cinema_key) ticket_num
    from t_f_con_member_ticket t,t_d_con_cinema d
   where t.member_key = #{memberId,jdbcType=DECIMAL}
    and t.cinema_key = d.cinema_key
    group by t.member_key,d.inner_code
    order by count(distinct t.bk_ticket_number || '' || t.cinema_key) -
		count(distinct t.re_ticket_number || '' || t.cinema_key) desc

  </select>
  
  <select id="getPointExchangeByCinema" parameterType="java.math.BigDecimal" resultMap="BaseResultMap">
  select t.member_key member_id,
	 d.inner_code cinema_key,
	count(distinct t.bk_ticket_number || '' || t.cinema_key) ticket_num
	from t_f_con_member_ticket t ,t_d_con_cinema d
	where t.pay_method_key = 232
	and t.member_key = #{memberId,jdbcType=DECIMAL}
	 and t.cinema_key = d.cinema_key
	group by t.member_key,d.inner_code
	order by count(distinct t.bk_ticket_number || '' || t.cinema_key) desc
  </select>
   
  <select id="getTicketLastBuys" parameterType="java.math.BigDecimal" resultMap="BaseResultMap">
  select member_key member_id, cinema_key
		from (select t.member_key,  d.inner_code cinema_key
		from t_f_con_member_ticket t ,t_d_con_cinema d
		where t.member_key =  #{memberId,jdbcType=DECIMAL}
		and t.cinema_key = d.cinema_key
		order by t.show_biz_date_key desc )
  </select>
  <select id="getTicketLastBuy" parameterType="java.math.BigDecimal" resultMap="BaseResultMap">
  select member_key member_id, cinema_key
		from (select t.member_key, d.inner_code cinema_key
		from t_f_con_member_ticket t,t_d_con_cinema d
		where t.member_key =  #{memberId,jdbcType=DECIMAL}
		and t.cinema_key = d.cinema_key
		order by t.show_biz_date_key desc  ,t.recordno desc)
		where rownum = 1
  </select>
   <select id="getLastPointExchangeTickets" parameterType="java.math.BigDecimal" resultMap="BaseResultMap">
	 select member_key, cinema_key
		from (select t.member_key,  d.inner_code cinema_key
		from t_f_con_member_ticket t,t_d_con_cinema d
		where t.member_key =  #{memberId,jdbcType=DECIMAL}
		and t.cinema_key = d.cinema_key
		order by t.show_biz_date_key desc)
  </select>
   <select id="getLastPointExchangeTicket" parameterType="java.math.BigDecimal" resultMap="BaseResultMap">
	 select member_key, cinema_key
		from (select t.member_key, d.inner_code cinema_key
		from t_f_con_member_ticket t,t_d_con_cinema d
		where t.member_key =  #{memberId,jdbcType=DECIMAL}
		and t.cinema_key = d.cinema_key
		order by t.show_biz_date_key desc,t.recordno desc)
		where rownum = 1
  </select>
  
 
</mapper>